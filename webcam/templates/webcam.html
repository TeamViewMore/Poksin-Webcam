{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream</title>
    <link rel="stylesheet" href="{% static 'css/webcam.css' %}">
    <style>
        /* 스타일 추가 */
    </style>
</head>
<body>
    <div class="home">
        <a href="{% url 'index' %}">
            <img src="{% static 'img/home.png' %}" alt="home"> <span>홈으로</span>
        </a>
    </div>
    <div class="webcam-container" id="webcamContainer" onclick="toggleWebcam()">
        <video id="webcamFeed" autoplay playsinline muted></video>
    </div>
    
    <script>
        let isWebcamOn = false; 
        let mediaRecorder;
        let recordedChunks = [];
        const webcamFeed = document.getElementById('webcamFeed');
        const userId = "{{ id }}";  // 사용자 ID를 템플릿에서 가져옴

        function toggleWebcam() {
            if (isWebcamOn) {
                stopWebcam();
            } else {
                startWebcam();
            }
        }

        function startWebcam() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        webcamFeed.srcObject = stream;
                        isWebcamOn = true;
                        startRecording(stream);
                    })
                    .catch(function(error) {
                        console.error("Error accessing webcam: ", error);
                        alert("Unable to access webcam. Please check your permissions.");
                    });
            } else {
                alert("Webcam not supported by your browser.");
            }
        }

        function stopWebcam() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (webcamFeed.srcObject) {
                webcamFeed.srcObject.getTracks().forEach(track => track.stop());
                webcamFeed.srcObject = null;
            }
            isWebcamOn = false;
        }

        function startRecording(stream) {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/mp4' });
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function() {
                const videoBlob = new Blob(recordedChunks, { type: 'video/mp4' });
                recordedChunks = [];
                uploadVideo(videoBlob);
            };

            mediaRecorder.start();
            setTimeout(() => {
                mediaRecorder.stop();
                if (isWebcamOn) {
                    startRecording(stream);
                }
            }, 60000); // 1 minute
        }

        function uploadVideo(blob) {
            const formData = new FormData();
            formData.append('video', blob);
            formData.append('user_id', userId);

            fetch("{% url 'upload_video' %}", {
                method: 'POST',
                body: formData
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Failed to upload video');
                }
                return response.json();
            }).then(data => {
                console.log('Video uploaded successfully:', data);
            }).catch(error => {
                console.error('Error uploading video:', error);
            });
        }
    </script>
</body>
</html>
