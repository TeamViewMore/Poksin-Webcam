{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream</title>
    <link rel="stylesheet" href="{% static 'css/webcam.css' %}">
    <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="home">
        <a href="{% url 'index' %}" id="homeButton">
            <img src="{% static 'img/home.png' %}" alt="home"> <span>홈으로</span>
        </a>
    </div>
    <div class="webcam-container" id="webcamContainer" onclick="toggleView()">
        <video id="webcamFeed" autoplay playsinline muted></video>
        <img id="staticImage" src="{% static 'img/stop_video.png' %}" alt="Static Image" class="static-image">
    </div>
    
    <script>
        let isWebcamOn = false; 
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        const webcamFeed = document.getElementById('webcamFeed');
        const staticImage = document.getElementById('staticImage');
        const userId = "{{ id }}";  // 사용자 ID를 템플릿에서 가져옴
        startWebcam();

        function startWebcam() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        webcamFeed.srcObject = stream;
                        isWebcamOn = true;
                        startRecording(stream);
                    })
                    .catch(function(error) {
                        console.error("Error accessing webcam: ", error);
                        alert("Unable to access webcam. Please check your permissions.");
                    });
            } else {
                alert("Webcam not supported by your browser.");
            }
        }

        function stopWebcam() {
            if (webcamFeed.srcObject) {
                webcamFeed.srcObject.getTracks().forEach(track => track.stop());
                webcamFeed.srcObject = null;
            }
            isWebcamOn = false;
        }

        function toggleView() {
            if (webcamFeed.style.display === 'none') {
                webcamFeed.style.display = 'block';
                staticImage.style.display = 'none';
                if (!isWebcamOn) {
                    startWebcam();
                }
            } else {
                webcamFeed.style.display = 'none';
                staticImage.style.display = 'block';
            }
        }

        function startRecording(stream) {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            isRecording = true;
            recordedChunks = [];

            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function() {
                const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                recordedChunks = [];
                uploadVideo(videoBlob);
                if (isRecording) {
                    startRecording(stream);
                }
            };

            mediaRecorder.start();
            setTimeout(() => {
                if (isRecording) {
                    mediaRecorder.stop();
                }
            }, 300000); // 5 minutes
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
            }
        }

        function uploadVideo(blob) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('video', blob);
                formData.append('user_id', userId);

                fetch("{% url 'upload_video' %}", {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to upload video');
                    }
                    return response.json();
                }).then(data => {
                    console.log('Video uploaded successfully:', data);
                    resolve();
                }).catch(error => {
                    console.error('Error uploading video:', error);
                    reject(error);
                });
            });
        }

        window.addEventListener('load', () => {
            startWebcam();
        });

        const homeButton = document.getElementById('homeButton');
        homeButton.addEventListener('click', async (event) => {
            if (isRecording) {
                event.preventDefault(); 
                stopRecording(); 
                if (recordedChunks.length > 0) {
                    try {
                        await uploadVideo(new Blob(recordedChunks, { type: 'video/webm' })); 
                        window.location.href = "/"; 
                    } catch (error) {
                        console.error('Failed to upload before leaving', error);
                    }
                } else {
                    window.location.href = "/"; 
                }
            }
        });
    </script>
</body>
</html>
